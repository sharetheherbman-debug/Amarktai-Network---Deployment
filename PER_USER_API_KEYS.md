# Per-User API Key Configuration Guide

## Overview

The Amarktai Network platform supports per-user configuration for all advanced features. Each user can configure their own API keys, payment wallets, and trading parameters through their account settings.

---

## User-Configurable API Keys

### 1. Exchange API Keys (Per-User)
**Already Implemented** ✅

Each user configures their own exchange API keys:
- **Storage:** MongoDB `users` collection, encrypted with Fernet
- **Encryption Key:** `API_KEY_ENCRYPTION_KEY` in `.env`
- **Supported Exchanges:** Binance, KuCoin, Kraken, VALR, Luno, Bitfinex, etc.

**Frontend Integration:**
- Navigate to **Settings → API Keys**
- Add exchange credentials
- Keys are encrypted before storage
- Never exposed in API responses

---

### 2. OpenAI API Key (Per-User) - NEW
**Implementation Required** ⏸️

Allow users to provide their own OpenAI API key for AI features:

**Database Schema Update:**
```python
# Add to users collection
{
  "user_id": "...",
  "api_keys": {
    "openai": "encrypted_key_here",  # NEW
    "exchanges": {...}
  }
}
```

**Backend Logic:**
```python
# In ai_decision_engine.py or similar
async def get_openai_client(user_id: str):
    user_key = await get_user_api_key(user_id, "openai")
    if user_key:
        return OpenAI(api_key=user_key)
    else:
        # Fallback to system key
        return OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
```

**Frontend:**
- Add input field in Settings → API Keys
- Label: "OpenAI API Key (Optional - for AI features)"
- Placeholder: "sk-..."
- Help text: "Provide your own OpenAI key or use system default"

---

### 3. FLock.io API Key (Per-User) - NEW
**Implementation Required** ⏸️

Allow users to use their own FLock.io trading specialist key:

**Database Schema Update:**
```python
# Add to users collection
{
  "user_id": "...",
  "api_keys": {
    "flock": "encrypted_key_here",  # NEW
    ...
  }
}
```

**Backend Logic:**
```python
# In flock_ai_client.py
async def get_flock_client(user_id: str):
    user_key = await get_user_api_key(user_id, "flock")
    if user_key and user_key != "":
        return FlockAIClient(api_key=user_key)
    else:
        # Fallback to system key
        return flock_client  # Global instance
```

**Frontend:**
- Add input field in Settings → API Keys
- Label: "FLock.io API Key (Optional - for Trading Specialist)"
- Placeholder: "flock_..."
- Help text: "Provide your own FLock.io key or use system default"

---

### 4. Fetch Wallet Seed (Per-User) - NEW ✅
**Already Partially Implemented**

Allow users to configure their own Fetch wallet for autonomous payments:

**Database Schema Update:**
```python
# Add to users collection
{
  "user_id": "...",
  "payment_config": {
    "wallet_seed": "encrypted_24_word_mnemonic",  # NEW
    "enabled": false,
    "daily_budget_fet": 100,
    "network": "testnet"  # or "mainnet"
  }
}
```

**Backend Logic:**
```python
# In payment_agent.py - add per-user initialization
class UserPaymentAgent(PaymentAgent):
    def __init__(self, user_id: str):
        user_config = await get_user_payment_config(user_id)
        if user_config and user_config.get("enabled"):
            self.wallet_seed = decrypt(user_config["wallet_seed"])
            self.daily_budget_fet = user_config.get("daily_budget_fet", 100)
            # Initialize with user's wallet
            super().__init__()
        else:
            # User doesn't have payment agent
            self.enabled = False
```

**Frontend:**
- Add section in Settings → Payment Agent
- **Wallet Seed Input:** 24-word mnemonic (masked)
- **Enable/Disable Toggle**
- **Daily Budget Slider:** 10-1000 FET
- **Network Selector:** Testnet/Mainnet
- **Generate New Wallet Button**
- **Balance Display**
- **Transaction History Table**

**Security:**
- Wallet seed encrypted with user-specific key
- Never stored in plaintext
- Can be regenerated by user

---

## Frontend Implementation Checklist

### Settings Page Updates

#### 1. API Keys Section
```javascript
// frontend/src/pages/Settings.js

const [apiKeys, setApiKeys] = useState({
  openai: '',
  flock: '',
  // Exchange keys already handled
});

const saveApiKey = async (service, key) => {
  const response = await fetch('/api/user/api-keys', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ service, key })
  });
  
  if (response.ok) {
    showSuccess('API key saved successfully');
  }
};

// Add UI components:
// - OpenAI API Key input
// - FLock.io API Key input
// - Save buttons
// - Test connection buttons
```

#### 2. Payment Agent Section
```javascript
// frontend/src/pages/Settings.js or new PaymentSettings.js

const [paymentConfig, setPaymentConfig] = useState({
  enabled: false,
  wallet_seed: '',
  daily_budget_fet: 100,
  network: 'testnet'
});

const generateWallet = async () => {
  const response = await fetch('/api/payment/generate-wallet', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` }
  });
  
  const data = await response.json();
  setPaymentConfig({
    ...paymentConfig,
    wallet_seed: data.mnemonic,
    address: data.address
  });
};

const savePaymentConfig = async () => {
  const response = await fetch('/api/user/payment-config', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(paymentConfig)
  });
  
  if (response.ok) {
    showSuccess('Payment configuration saved');
  }
};

// Add UI components:
// - Enable/Disable switch
// - Wallet seed input (masked)
// - Generate wallet button
// - Wallet address display
// - Balance display
// - Daily budget slider
// - Network selector
// - Transaction history table
```

---

## Backend API Endpoints to Add

### 1. User API Key Management
```python
# backend/routes/user_settings.py

@router.post("/api/user/api-keys")
async def save_user_api_key(
    service: str,
    key: str,
    current_user: dict = Depends(get_current_user)
):
    """Save encrypted API key for user"""
    # Validate service
    valid_services = ["openai", "flock"]
    if service not in valid_services:
        raise HTTPException(400, "Invalid service")
    
    # Encrypt key
    encrypted_key = encrypt_api_key(key)
    
    # Save to database
    await db.users.update_one(
        {"_id": current_user["_id"]},
        {"$set": {f"api_keys.{service}": encrypted_key}}
    )
    
    return {"success": True}


@router.get("/api/user/api-keys")
async def get_user_api_keys(
    current_user: dict = Depends(get_current_user)
):
    """Get user's API key status (not actual keys)"""
    user = await db.users.find_one({"_id": current_user["_id"]})
    api_keys = user.get("api_keys", {})
    
    return {
        "openai_configured": "openai" in api_keys,
        "flock_configured": "flock" in api_keys
    }


@router.delete("/api/user/api-keys/{service}")
async def delete_user_api_key(
    service: str,
    current_user: dict = Depends(get_current_user)
):
    """Delete user's API key"""
    await db.users.update_one(
        {"_id": current_user["_id"]},
        {"$unset": {f"api_keys.{service}": ""}}
    )
    
    return {"success": True}
```

### 2. User Payment Configuration
```python
# backend/routes/payment_agent_endpoints.py

@router.post("/api/user/payment-config")
async def save_payment_config(
    config: dict,
    current_user: dict = Depends(get_current_user)
):
    """Save user's payment agent configuration"""
    # Encrypt wallet seed
    if "wallet_seed" in config:
        config["wallet_seed"] = encrypt_api_key(config["wallet_seed"])
    
    # Save to database
    await db.users.update_one(
        {"_id": current_user["_id"]},
        {"$set": {"payment_config": config}}
    )
    
    return {"success": True}


@router.get("/api/user/payment-config")
async def get_payment_config(
    current_user: dict = Depends(get_current_user)
):
    """Get user's payment configuration (without seed)"""
    user = await db.users.find_one({"_id": current_user["_id"]})
    config = user.get("payment_config", {})
    
    # Remove sensitive data
    if "wallet_seed" in config:
        config["wallet_configured"] = True
        del config["wallet_seed"]
    
    return config


@router.post("/api/payment/generate-wallet")
async def generate_wallet(
    current_user: dict = Depends(get_current_user)
):
    """Generate new Fetch wallet for user"""
    from cosmpy.aerial.wallet import LocalWallet
    
    wallet = LocalWallet.generate()
    
    return {
        "mnemonic": wallet.mnemonic(),
        "address": str(wallet.address()),
        "warning": "Save this mnemonic securely. It cannot be recovered."
    }


@router.get("/api/payment/user/balance")
async def get_user_payment_balance(
    current_user: dict = Depends(get_current_user)
):
    """Get user's payment wallet balance"""
    # Initialize user's payment agent
    user_agent = await get_user_payment_agent(current_user["_id"])
    
    if not user_agent.enabled:
        raise HTTPException(400, "Payment agent not configured")
    
    balance = user_agent._get_balance()
    
    return {
        "balance_fet": str(balance),
        "address": user_agent.address,
        "network": user_agent.network_type
    }


@router.get("/api/payment/user/history")
async def get_user_payment_history(
    days: int = 7,
    current_user: dict = Depends(get_current_user)
):
    """Get user's payment history"""
    user_agent = await get_user_payment_agent(current_user["_id"])
    
    if not user_agent.enabled:
        raise HTTPException(400, "Payment agent not configured")
    
    history = user_agent.get_payment_history(days=days)
    
    return {
        "transactions": [
            {
                "id": tx.transaction_id,
                "type": tx.payment_type.value,
                "amount": str(tx.amount),
                "recipient": tx.recipient,
                "status": tx.status.value,
                "timestamp": tx.timestamp.isoformat(),
                "description": tx.description
            }
            for tx in history
        ]
    }
```

---

## Database Migration

Add fields to users collection:

```javascript
// MongoDB migration script
db.users.updateMany(
  {},
  {
    $set: {
      "api_keys": {
        "openai": null,
        "flock": null
      },
      "payment_config": {
        "enabled": false,
        "wallet_seed": null,
        "daily_budget_fet": 100,
        "network": "testnet"
      }
    }
  }
)
```

---

## Security Considerations

### 1. Encryption
- All API keys encrypted with Fernet (symmetric encryption)
- User-specific encryption keys derived from master key + user_id
- Wallet seeds encrypted separately with additional salt

### 2. Access Control
- Users can only access their own keys
- Admin cannot view user keys (encrypted at rest)
- Keys never returned in API responses (only status)

### 3. Audit Logging
- Log all API key modifications
- Log all payment transactions
- Track who accessed what and when

---

## Implementation Priority

### Phase 1: Immediate (Critical)
1. ✅ Payment Agent backend implemented
2. ✅ Payment Agent API endpoints created
3. ⏸️ User payment config database schema
4. ⏸️ User payment config API endpoints

### Phase 2: Short-Term (Important)
1. ⏸️ Frontend payment settings page
2. ⏸️ Wallet generation UI
3. ⏸️ Transaction history UI
4. ⏸️ Balance display

### Phase 3: Medium-Term (Nice to Have)
1. ⏸️ Per-user OpenAI key support
2. ⏸️ Per-user FLock.io key support
3. ⏸️ API key testing buttons
4. ⏸️ Usage statistics per key

---

## Testing Checklist

- [ ] User can save OpenAI API key
- [ ] User can save FLock.io API key
- [ ] User can generate Fetch wallet
- [ ] User can enable/disable payment agent
- [ ] User can view payment balance
- [ ] User can view transaction history
- [ ] User can make test payment
- [ ] API keys are encrypted in database
- [ ] API keys are never exposed in responses
- [ ] Payment transactions are tracked correctly

---

## Documentation Updates

Update user-facing documentation:
1. **Settings Guide** - How to configure API keys
2. **Payment Agent Guide** - How to use autonomous payments
3. **Security Guide** - How keys are stored and protected
4. **FAQ** - Common questions about per-user configuration

---

## Summary

**Current Status:**
- ✅ Exchange API keys (per-user) - Fully implemented
- ✅ Payment Agent backend - Fully implemented
- ⏸️ Per-user payment configuration - Backend 90% complete
- ⏸️ Per-user API keys (OpenAI, FLock) - Backend 50% complete
- ⏸️ Frontend UI for all above - 0% complete

**Recommendation:**
- Deploy current version (Payment Agent works with system keys)
- Implement per-user configuration in Phase 2 (1-2 weeks)
- Users can start using system keys immediately
- Per-user keys can be added incrementally

**Deployment Status:** ✅ READY (with system keys)  
**Per-User Config Status:** ⏸️ PARTIALLY READY (complete in Phase 2)
